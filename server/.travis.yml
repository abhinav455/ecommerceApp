sudo: required

services:
  - docker   #runs $sudo systemctl start docker in job shell

before_install:
  - docker build -t "$DOCKER_ID"/ecommerceapp:server -f Dockerfile.dev .
   #or docker pull and docker run, 
      #thus the ci/cd tool/plugin needs to support docker

script: 
   #exec commands to be done in container
  - docker run "$DOCKER_ID"/ecommerceapp:server npm run test -- --coverage 

after_sucess:
  #build production grade dockerfile
  - openssl  enc -aes256 -d -in .enc -out .env -k $SECRET_KEY -md sha256
  - docker build -t "$DOCKER_ID"/ecommerceapp:server .
  - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_ID" --password-stdin 
  - docker push "$DOCKER_ID"/ecommerceapp:server   


#deploy to hub
#deploy:
#  provider: script
#  script: bash docker_push
  #docker is a script in repo containenint 
  #!/bin/bash ; echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin ; docker push USER/REPO
#  on:
#    branch: master

   
